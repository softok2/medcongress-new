{% extends "MedCongressApp/base.html"%}
{% load static %}
{% block titulo %}
Editar Perfil
{%endblock%}

{%block css%}
<link rel="stylesheet" type="text/css"
    href="{% static 'MedCongressAdmin/assets/css/cropper.css' %}">
<style>
	#geomap {
		width: 100%;
		height: 400px;
	}

	.img-container img {
      max-width: 100%;
    }
    .modal-backdrop {
   
z-index: 0;
    }
</style>

{%endblock%}
{% block contenido %}
<section class="update-profile">
    <div class="container-fluid">
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">Localidad</h4>
                    </div>
                    <div class="modal-body">
                        <div id="geomap"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
    
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-3">
                <a href="{% url 'perfil' %}"  class="profile-cta">VOLVER AL PERFIL</a>
              
            </div>

            <div class="col-md-8 content">
                {% if form.errors %}
                {% for field in form %}
                    {% for error in field.errors %}
                    
                        <div class="alert alert-danger alert-dismissible mb-2" role="alert">
                           
                            {{ error|safe|escape }}
                        </div>
                    {% endfor %}
                {% endfor %}
                {% for error in form.non_field_errors %}
                <div class="alert alert-danger alert-dismissible mb-2" role="alert">
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                    {{ error|safe|escape }}
                </div>
                {% endfor %}
            {% endif %}
            <form class="contactusform" action="{% url 'Edit_perfil' %}" method="post" enctype="multipart/form-data" id="form">
                    {% csrf_token %}
                    
                    <div class="profile-section section-1">
                        <div class="row">
                            <div class="col d-flex justify-content-between align-items-center">
                                <h2 class="profile-title"><strong>Actualizar Perfil de MED Congress</strong></h2>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <span class="subtitle">Manten actualizado tu perfil</span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-5 border-right-gray pe-md-4 d-flex flex-column justify-content-between">
                                {%if imagen_seg_url%}	
                                <label class="label" data-toggle="tooltip" title="Clic para cambiar foto">
                                    <div class="row">
                                        <div class="col-md-12">
                                        <img class="img-fluid profile-img w-100" id="avatar" src="{% static '/' %}{{imagen_seg_url}}"  alt="avatar" >
                                        </div>
                                    
                                    
                                </div>
                                <input type="file" class="sr-only" id="input" name="image" accept="image/*">
                                    <input type="hidden" id="prueba" name="prueba">
                                  </label>
                                  
                                {% else%}

                                <label class="label" data-toggle="tooltip" title="Clic para cambiar foto">
                                    <img class="img-fluid profile-img w-100" id="avatar" src="{% static 'MedCongressApp/images/defaulthombre.png' %}"  alt="avatar">
                                    <input type="file" class="sr-only" id="input" name="image" accept="image/*">
                                    <input type="hidden" id="prueba" name="prueba">
                                  </label>
                                    {%endif%}
                                    
                                    
                                      <div class="alert" role="alert"></div>
                                      <div class="modal fade " id="modal1" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
                                        <div class="modal-dialog " role="document">
                                          <div class="modal-content">
                                            <div class="modal-header">
                                              <h5 class="modal-title" id="modalLabel">Editar la Imagen</h5>
                                              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                              </button>
                                            </div>
                                            <div class="modal-body">
                                              <div class="img-container ">
                                                <img id="image" src="https://avatars0.githubusercontent.com/u/3456749">
                                              </div>
                                            </div>
                                            <div class="modal-footer">
                                              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                              <button type="button" class="btn btn-primary" id="crop">Guardar</button>
                                            </div>
                                          </div>
                                        </div>
                                      </div>
                            </div>
                           
                            <div class="col-md-7 ps-md-4 fields-wraper">
                                <div class="field-group name-group mb-3 me-md-2 mt-5 mt-md-0">
                                    <label>Nombre</label>
                                    {{form.user.first_name }} {{form.user.first_name.help_text }}
                                </div>
                                <div class="field-group last-name-group mb-3 ms-md-2">
                                    <label>Apellidos</label>
                                    {{form.user.last_name }}
                                </div>
                                <div class="field-group mail-group mb-3">
                                    <label>Correo</label>
                                    {{form.user.email }} 
                                </div>
                                <div class="field-group location-group mb-3 ">
                                    <label>Lugar</label>
                                    {{form.ubicacion.direccion }}
                                </div>
                               
                                <div class="field-group phone-group mb-3 me-md-2">
                                    <label>Teléfono</label>
                                    {{form.perfiluser.num_telefono }}
                                </div>
                                <div class="field-group date-group mb-3 ms-md-2">
                                    <label>Fecha de Nacimiento</label>
                                    
                                   
                                    <input type="date" name="perfiluser-fecha_nacimiento" class="form-control" id="id_perfiluser-fecha_nacimiento">
                                </div>   
                                <div class="field-group gender-group mb-3 me-md-2">
                                    <label>Género</label>
                                    {{form.perfiluser.genero }}
                                </div>
                                <div class="field-group cat mb-3 ms-md-2">
                                    <label>Categoría</label>
                                    <select name="perfiluser-categoria" class="form-control" required="" id="id_perfiluser-categoria">
                                        <option value="">---------</option>
                                      {%for categoria in categorias%}
                                        <option value="{{categoria.pk}}">{{categoria.nombre}}</option>
                                      {%endfor%}
                                      </select>
                                </div>
                               
                                <div class="form-check d-flex align-items-center ps-0">
                                    {{form.perfiluser.is_ponente }}
                                    <label class="form-check-label" for="flexCheckDefault">
                                        Desearía ser ponente en un evento 
                                    </label>
                                </div>
                                <div class="col-sm-3 ">
                                    <div class="form-group" style="display: none;">
                                        <label
                                            for="{{form.ubicacion.longitud.id_for_label }}"><b>{{form.ubicacion.longitud.label }}</b></label>

                                        {{form.ubicacion.longitud }}
                                    </div>
                                </div>
                                <div class="col-sm-3 " style="display: none;">
                                    <div class="form-group">
                                        <label
                                            for="{{form.ubicacion.latitud.id_for_label }}"><b>{{form.ubicacion.latitud.label }}</b> </label>

                                        {{form.ubicacion.latitud }}
                                    </div>
                                </div>
                                <div class="col-sm-3 " style="display: none;">
                                    <div class="form-group">
                                        <label for="{{form.user.username.id_for_label }}"><b>{{form.user.username.label }}
                                            </b> </label>

                                        {{form.user.username }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <h3 class="update-profile-section-heading">PROFESIONAL</h3>
                    <div class="profile-section section-2">
                        <div class="row flex-md-row flex-column mb-3 me-md-2">
                            <div class="field-group gender-group mb-3 me-md-2">
                                <label>Puesto Actual</label>
                                {{form.perfiluser.puesto }}
                            </div>
                            <div class="field-group  gender-group mb-3 me-md-2">
                                <label>Especialidad</label>
                                {{form.perfiluser.especialidad }}
                            </div>
                            
                        </div>
                    </div>

                    <h3 class="update-profile-section-heading">REDES SOCIALES</h3>
                    <div class="profile-section section-2">
                        <div class="row flex-md-row flex-column">
                            <div class="col">
                                <label>Facebook</label>
                                {{form.perfiluser.facebook }}
                            </div>
                            <div class="col mt-2 mt-md-0">
                                <label>Linkedin</label>
                                {{form.perfiluser.linkedin }}
                            </div>
                            <div class="col mt-2 mt-md-0">
                                <label>Youtube</label>
                                {{form.perfiluser.youtube }}
                            </div>
                            <div class="col mt-2 mt-md-0">
                                <label>Twitter</label>
                                {{form.perfiluser.twitter }}
                            </div>
                        </div>
                    </div>
                    
                    <h3 class="update-profile-section-heading">LOGROS ACADÉMICOS</h3>
                    {{form.perfiluser.detalle }}
                    <div style="margin-bottom: 20px;"></div>
                    <h3 class="update-profile-section-heading">PUBLICACIONES</h3>
                    {{form.perfiluser.publicaciones }}
                    <div style="margin-bottom: 20px;"></div>
                    <h3 class="update-profile-section-heading">DATOS DE INTERES</h3>
                    {{form.perfiluser.datos_interes }}
                   <div style="margin-bottom: 20px;"></div>
                   <a href="#" id="submit"  class="profile-cta">ACTUALIZAR PERFIL</a>
                   <div style="margin-bottom: 20px;"></div>
                </form>  
            </div>
        </div>
    </div>
</section>
{% endblock%}

{%block script%}
<script type="text/javascript"
	src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD1XvgQocD9EY4v5Dcti8-MGnonZQ43zYU"></script>
<link rel="stylesheet" href="{% static 'MedCongressApp/css/jquery-ui.min.css'%}">
<script src="{% static 'MedCongressApp/js/plugins/jquery-ui/jquery-ui.min.js'%}"></script>
<script src="{% static 'MedCongressAdmin/app-assets/vendors/js/editors/ckeditor/ckeditor.js'%}"></script>
<script src="{% static 'MedCongressAdmin/app-assets/js/scripts/editors/editor-ckeditor.js'%}"></script>
<script src="{% static 'MedCongressApp/js/lugar.js'%}"></script>
<script src="{% static 'MedCongressAdmin/assets/js/cropper.js'%}"></script>
<script>


    $(document).ready(function () {
        {%if cat %}
        $("#id_perfiluser-categoria option[value='{{cat}}']").attr("selected", true);
        {%endif%}
        $('#submit').click(function (){
        $('#form').submit();
       
    }
        );
        
        {% if fecha_nac%}
            $("#id_perfiluser-fecha_nacimiento").val('{{ fecha_nac|date:"Y-m-d" }}');
        {%endif%}
        FiltrarLugar('#id_ubicacion-direccion', '#id_ubicacion-longitud', '#id_ubicacion-latitud');
        $('#id_ubicacion-direccion').keypress(function () {
            $('#id_ubicacion-latitud').val('');
            $('#id_ubicacion-longitud').val('');

        });

        $("#esp_div").hide();
        $("#cel_prof").hide();
        $("#new_cat").hide();
        if ($('#id_perfiluser-categoria option:selected').text() == 'Médico' || $('#id_perfiluser-categoria option:selected').text() == 'Residente') {

            $("#esp_div").show();
            $("#cel_prof").show();

            $("#id_perfiluser-especialidad").attr('required', 'True');
            $("#id_perfiluser-cel_profecional").attr('required', 'True');


        }
        else {
            $("#esp_div").hide();
            $("#cel_prof").hide();
            $("#id_perfiluser-especialidad").val('');
            $("#id_perfiluser-cel_profecional").val('');
            $("#id_perfiluser-especialidad").removeAttr('required')
            $("#id_perfiluser-cel_profecional").removeAttr('required')

        }
        if ($('#id_perfiluser-categoria option:selected').text() == 'Otra') {
            $("#new_cat").show();
            $("#id_categoria-nombre").attr('required', 'True');

        }
        else {
            $("#new_cat").hide();
            $("#id_categoria-nombre").val('')
            $("#id_categoria-nombre").removeAttr('required');
        }


        $('#id_perfiluser-categoria').change(function () {

            if ($('#id_perfiluser-categoria option:selected').text() == 'Médico' || $('#id_perfiluser-categoria option:selected').text() == 'Residente') {

                $("#esp_div").show();
                $("#cel_prof").show();
                $("#id_perfiluser-especialidad").attr('required', 'True')
                $("#id_perfiluser-cel_profecional").attr('required', 'True')
            }
            else {
                $("#id_perfiluser-especialidad").val('');
                $("#id_perfiluser-cel_profecional").val('');
                $("#esp_div").hide();
                $("#cel_prof").hide();
                $("#id_perfiluser-especialidad").removeAttr('required')
                $("#id_perfiluser-cel_profecional").removeAttr('required')

            }
            if ($('#id_perfiluser-categoria option:selected').text() == 'Otra') {
                $("#new_cat").show();
                $("#id_categoria-nombre").attr('required', 'True')

            }
            else {
                $("#new_cat").hide();
                $("#id_categoria-nombre").val('')
                $("#id_categoria-nombre").removeAttr('required')
            }

        });

        $('#pol').change(function () {
            if ($('#pol').prop('checked')) {
                $("#submit").removeAttr('disabled')
            }
            else {
                $("#submit").attr('disabled', 'disabled')
            }

        });


    });

    function VerMapa() {

        $('.geomap').slideToggle();
        $('.mapa').slideToggle(1);
    }
    
    window.addEventListener('DOMContentLoaded', function () {
      var avatar = document.getElementById('avatar');
      var image = document.getElementById('image');
      var input = document.getElementById('input');
      var $progress = $('.progress');
      var $progressBar = $('.progress-bar');
      var $alert = $('.alert');
      var $modal = $('#modal1');
      var cropper;

      $('[data-toggle="tooltip"]').tooltip();

      input.addEventListener('change', function (e) {
        var files = e.target.files;
        var done = function (url) {
          input.value = '';
          image.src = url;
          $alert.hide();
          $modal.modal('show');
        };
        var reader;
        var file;
        var url;

        if (files && files.length > 0) {
		  file = files[0];
		 
            tipo_imagen=files[0].name.split('.');
			if(tipo_imagen[1]!='jpg' && tipo_imagen[1]!='png' && tipo_imagen[1]!='jpeg')
			{
				
				swal("Cancelado", "Solo admimite archivos .jpeg , .jpg y .png.", "error");
				return;	
			}
          if (URL) {
            done(URL.createObjectURL(file));
          } else if (FileReader) {
            reader = new FileReader();
            reader.onload = function (e) {
              done(reader.result);
            };
            reader.readAsDataURL(file);
          }
        }
      });

      $modal.on('shown.bs.modal', function () {
		

		$('#image').width($modal.width());
		
		
        cropper = new Cropper(image, {
          aspectRatio: 500/600,
		  viewMode: 1,
		  
		  
		  ready: function () {
            //Should set crop box data first here
            cropper.setCropBoxData(cropBoxData).setCanvasData(canvasData);
          }
        });
      }).on('hidden.bs.modal', function () {
        cropper.destroy();
        cropper = null;
      });

      document.getElementById('crop').addEventListener('click', function () {
        var initialAvatarURL;
        var canvas;

        $modal.modal('hide');

        if (cropper) {
          canvas = cropper.getCroppedCanvas({
            width: 500,
            height: 600,
          });
          initialAvatarURL = avatar.src;
          avatar.src = canvas.toDataURL();
          $('#prueba').val(canvas.toDataURL());
		  $progress.show();
		
		  $alert.removeClass('alert-success alert-warning');  
		  $alert.show().addClass('alert-success').text('Nueva Imagen Cargada');
      
        }
      });
    });
</script>
{%endblock%}